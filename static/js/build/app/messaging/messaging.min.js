!function e(s,t,r){function n(o,a){if(!t[o]){if(!s[o]){var c="function"==typeof require&&require;if(!a&&c)return c(o,!0);if(i)return i(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var u=t[o]={exports:{}};s[o][0].call(u.exports,function(e){var t=s[o][1][e];return n(t?t:e)},u,u.exports,e,s,t,r)}return t[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)n(r[o]);return n}({1:[function(e,s,t){"use strict";var r=angular.module("general.directives",[]);r.directive("alerts",[function(){return{restrict:"E",scope:{messages:"="},templateUrl:Urls["messaging_api:partial_base"]()+"directive/alerts",link:function(e,s){s.find("button").bind("click",function(){e.$apply(function(){e["class"]="",e.msg=""})})},controller:["$scope",function(e){e["class"]="",e.setMessage=function(s){e.messages[s]&&(e.msg=e.messages[s],e["class"]="alert-"+s,e.messages={})},angular.forEach(["success","danger","warning","info"],function(s){e.$watch("messages."+s,function(){e.setMessage(s)},!0)})}]}}]),r.directive("modalConfirm",[function(){return{restrict:"E",scope:{uid:"@",title:"@",body:"@",cancel:"&",confirm:"&"},templateUrl:Urls["messaging_api:partial_base"]()+"directive/modalConfirm"}}]),r.directive("pagination",[function(){return{restrict:"E",scope:{perPage:"@",currentPage:"=",total:"=",fetchPage:"&"},templateUrl:Urls["messaging_api:partial_base"]()+"directive/pagination",controller:["$scope",function(e){e.currentPage=0,e.pageCount=0,e.pages=[],e.calculatePageCount=function(){0===e.total?e.pageCount=1:e.pageCount=Math.ceil(e.total/e.perPage)},e.calculatePages=function(){var s,t,r;for(s=1,t=e.pageCount,e.pages=[],r=s;t>=r;++r)e.pages.push(r)},e.$watch("currentPage",function(){e.calculatePages()}),e.$watch("total",function(){e.calculatePageCount(),e.calculatePages()}),e.prevPage=function(){e.currentPage>0&&--e.currentPage},e.prevPageDisabled=function(){var s=0===e.currentPage?"disabled":"";return s},e.nextPage=function(){e.currentPage<e.pageCount-1&&e.currentPage++},e.nextPageDisabled=function(){var s=e.currentPage===e.pageCount-1?"disabled":"";return s},e.pageDisabled=function(s){var t=e.currentPage===s;return t},e.gotoPage=function(s){e.currentPage=s}}]}}])},{}],2:[function(e,s,t){"use strict";var r=angular.module("general.filters",[]);r.filter("raw",["$sce",function(e){return function(s){return e.trustAsHtml(s)}}])},{}],3:[function(e,s,t){"use strict";var r=angular.module("general.services",[]);r.service("genericSrv",["$http","$q",function(e,s){this.genericGet=function(e){return this._genericVerb("get",e,{})},this.genericPost=function(e,s){return this._genericVerb("post",e,s)},this._genericVerb=function(t,r,n){var i=s.defer();return e[t](r,n).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise}}]),r.service("messageSrv",function(){this.messages={},this.collect=function(){var e={};return angular.copy(this.messages,e),this.messages={},e}})},{}],4:[function(e,s,t){"use strict";var r=angular.module("messagingApp",["messagingApp.controllers","messagingApp.services","general.directives","general.filters","general.services","ngRoute","ngSanitize"]);r.constant("CONFIG",window.CONFIG),delete window.CONFIG,r.config(["$routeProvider","$httpProvider",function(e,s){s.defaults.xsrfCookieName="csrftoken",s.defaults.xsrfHeaderName="X-CSRFToken",s.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",e.when("/",{templateUrl:Urls["messaging_api:partial_base"]()+"route/listMessages",controller:"listMessagesCtrl"}).when("/compose",{templateUrl:Urls["messaging_api:partial_base"]()+"route/composeMessage",controller:"composeMessageCtrl"}).when("/reply/:id",{templateUrl:Urls["messaging_api:partial_base"]()+"route/composeMessage",controller:"composeMessageCtrl"}).when("/read/:id",{templateUrl:Urls["messaging_api:partial_base"]()+"route/readThread",controller:"readThreadCtrl"}).otherwise({redirectTo:"/"})}])},{}],5:[function(e,s,t){"use strict";e("./angular-app"),e("./controllers"),e("./services"),e("../general/directives"),e("../general/filters"),e("../general/services")},{"../general/directives":1,"../general/filters":2,"../general/services":3,"./angular-app":4,"./controllers":6,"./services":7}],6:[function(e,s,t){"use strict";var r=angular.module("messagingApp.controllers",[]);r.controller("listMessagesCtrl",["$scope","$timeout","genericSrv","messageSrv","inboxSortSrv","CONFIG",function(e,s,t,r,n,i){e.perPage=10,e.inbox=null,e.total=0,e.currentPage=0,e.timeoutPromise=null,e.messages=r.collect(),e.sort=n.toFlags(),e.showMessageItemIds=i.showMessageItemIds,e.firstTime=!0,e.getPageOfInbox=function(){var r=Urls["messaging_api:get_inbox"]()+"?page="+e.currentPage+"&per_page="+e.perPage+"&sort_field="+n.sortField+"&sort_dir="+n.sortDirection;s.cancel(e.timeoutPromise),t.genericGet(r).then(function(s){e.inbox=s.messages,e.total=s.total,e.firstTime&&0===e.total&&(e.firstTime=!1,e.messages.info=i.trans.empty_inbox)},function(s){e.inbox=null,e.total=0,e.messages.danger=s.errorMessage})["finally"](function(){e.timeoutPromise=s(function(){e.getPageOfInbox(e.currentPage)},1e4)})},e.setSort=function(s){s===n.sortField?n.toggleSortDirection():n.sortField=s,e.sort=n.toFlags(),e.getPageOfInbox(e.currentPage)},e.$watch("currentPage",function(s){e.getPageOfInbox(s)}),e.$on("$destroy",function(){s.cancel(e.timeoutPromise)})}]),r.controller("composeMessageCtrl",["$scope","$timeout","$location","$routeParams","genericSrv","messageSrv","CONFIG",function(e,s,t,r,n,i,o){if(e.timeoutPromise=e.sendTo=e.sendToChoices=null,e.sendToChoicesCount=e.sendToChoicesMax=0,e.messages=i.collect(),e.searching=!1,e.minSearchChars=o.minSearchChars,e.isSuperUser=o.isSuperUser,e.replySender=null,e.replyTo=e.replyBody="",e.newMessage=!1,e.msg={recipients:[],targetAll:!1,subject:"",body:"",miid:r.id?r.id:0},e.msg.miid){var a=Urls["messaging_api:get_reply_info"]()+"?miid="+e.msg.miid;n.genericGet(a).then(function(s){e.msg.recipients=s.recipients,e.msg.subject=s.subject,e.replySender=s.recipients[0],e.replyTo=s.sender,e.replyBody=s.body},function(s){i.messages[s.type]=s.errorMessage,t.path("/read/"+e.msg.miid)})}else e.newMessage=!0;e.sendToKeyUp=function(){s.cancel(e.timeoutPromise),e.timeoutPromise=s(function(){e.searchRecipient()},500)},e.searchRecipient=function(){var s;e.sendTo&&(e.sendTo.length>=e.minSearchChars?(e.searching=!0,s={q:e.sendTo,recipients:e.msg.recipients},n.genericPost(Urls["messaging_api:search_recipient"](),s).then(function(s){e.addChoices(s)},function(s){e.messages.danger=s.errorMessage,e.sendToChoices=null})["finally"](function(){e.searching=!1})):e.sendTo.length<e.minSearchChars&&(e.sendToChoices=null))},e.addRecipient=function(s){e.msg.recipients.push(s),e.removeChoice(s),e.searchRecipient()},e.removeRecipient=function(s){e.msg.recipients=e.msg.recipients.filter(function(e){return e.id!==s.id}),e.searchRecipient()},e.addChoices=function(s){e.sendToChoices=s.searchResults.filter(function(s){var t,r;for(t=0,r=e.msg.recipients.length;r>t;++t)if(e.msg.recipients[t].id===s.id)return!1;return!0}),e.sendToChoicesCount=s.count,e.sendToChoicesMax=s.max},e.removeChoice=function(s){e.sendToChoices=e.sendToChoices.filter(function(e){return e.id!==s.id})},e.targetAllChanged=function(){e.msg&&e.msg.targetAll&&(e.sendTo="",e.sendToChoices=[],e.msg.recipients=[])},e.sendMessage=function(){n.genericPost(Urls["messaging_api:send_message"](),e.msg).then(function(s){i.messages.success=s.successMessage,e.msg.miid?t.path("/read/"+e.msg.miid):t.path("/")},function(e){i.messages[e.type]=e.errorMessage,t.path("/")})},e.isSender=function(s){return e.msg.miid&&e.replySender?s.id===e.replySender.id:!1},e.$on("$destroy",function(){s.cancel(e.timeoutPromise)})}]),r.controller("readThreadCtrl",["$scope","$timeout","$location","$routeParams","genericSrv","messageSrv","CONFIG",function(e,s,t,r,n,i,o){e.messageItemId=r.id,e.messages=i.collect(),e.timeoutPromise=null,e.showMessageItemIds=o.showMessageItemIds,e.unread=[],e.getThread=function(){var a=Urls["messaging_api:get_thread"]()+"?miid="+r.id;s.cancel(e.timeoutPromise),n.genericGet(a).then(function(t){e.subject=t.subject,e.thread=t.messages,e.storeUnread(),e.total=t.total,0===e.total&&(e.messages.info=o.trans.empty_thread),e.timeoutPromise=s(function(){e.getThread()},1e4)},function(e){i.messages[e.type]=e.errorMessage,t.path("/")})},e.getThread(),e.storeUnread=function(){var s,t;for(s=0,t=e.thread.length;t>s;++s)e.thread[s].read||-1!==e.unread.indexOf(e.thread[s].id)||e.unread.push(e.thread[s].id)},e.isRead=function(s){return-1===e.unread.indexOf(s.id)},e.openModal=function(t,r){s.cancel(e.timeoutPromise),e.miid=r,jQuery("#"+t).modal({})},e.cancelDeleteMessage=function(s){var t=jQuery("#"+s);t.off("hidden.bs.modal"),t.on("hidden.bs.modal",function(){e.getThread()}),t.modal("hide")},e.deleteOne=function(s){var t,r=jQuery("#"+s);r.off("hidden.bs.modal"),r.on("hidden.bs.modal",function(){var s=e.miid;e.miid=null,s&&(t=Urls["messaging_api:delete_message_item"]()+"?miid="+s,n.genericGet(t).then(function(s){e.messages.success=s.successMessage},function(s){e.messages[s.type]=s.errorMessage})["finally"](function(){e.getThread()}))}),r.modal("hide")},e.deleteAll=function(s){var r,o=jQuery("#"+s);o.off("hidden.bs.modal"),o.on("hidden.bs.modal",function(){e.total&&(r=Urls["messaging_api:delete_message_item"]()+"?miid="+e.thread[0].id+"&thread",n.genericGet(r).then(function(e){i.messages.success=e.successMessage,t.path("/")},function(s){e.messages[s.type]=s.errorMessage,e.getThread()}))}),o.modal("hide")},e.$on("$destroy",function(){s.cancel(e.timeoutPromise)})}])},{}],7:[function(e,s,t){"use strict";var r=angular.module("messagingApp.services",[]);r.service("inboxSortSrv",function(){this.sortField="date",this.sortDirection="desc",this.toFlags=function(){return{sender:"sender"===this.sortField,senderAsc:"sender"===this.sortField&&"asc"===this.sortDirection,senderDesc:"sender"===this.sortField&&"desc"===this.sortDirection,date:"date"===this.sortField,dateAsc:"date"===this.sortField&&"asc"===this.sortDirection,dateDesc:"date"===this.sortField&&"desc"===this.sortDirection}},this.toggleSortDirection=function(){"asc"===this.sortDirection?this.sortDirection="desc":this.sortDirection="asc"}})},{}]},{},[5]);